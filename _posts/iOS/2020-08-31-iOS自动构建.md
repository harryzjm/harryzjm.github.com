---  
layout: post  
title: iOSè‡ªåŠ¨æ„å»º  
category: iOS  
tags: iOS  
keywords: iOS  
description: 
---  

__Posted by [ZenonHuang](https://juejin.im/post/6860260103791050760)__  


## æ„å»ºå‰

### 1. è®¾ç½®æ„å»ºå

é¦–å…ˆè®¾ç½®æˆ‘ä»¬çš„æ„å»ºåç§°ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨åˆ°å‡ ä¸ªå‚æ•°:

* BUILD_NUMBER ,Jenkins è‡ªå¸¦çš„å‚æ•°ï¼Œä»£è¡¨ç¬¬å‡ æ¬¡æ„å»º
* BetaPlatform ,è®¾ç½®çš„é€‰é¡¹å‚æ•°ï¼Œä»£è¡¨åˆ†å‘å¹³å°ã€‚æˆ‘è¿™é‡Œçš„å€¼åˆ†åˆ«æ˜¯:`fir`,`pgyer`,`appstore`
* Mode,è®¾ç½®çš„é€‰é¡¹å‚æ•°ï¼Œä»£è¡¨ Xcode æ„å»ºçš„ç¯å¢ƒè®¾ç½®ï¼Œä¸ºÂ `Snapshot`Â å’ŒÂ `Release`
* Branch,Jenkins è‡ªå¸¦çš„å‚æ•°ï¼Œä»£è¡¨ Git åˆ†æ”¯åç§°

![buildName](/assets/postAssets/2019/20200813075146.png)


### 2. é…ç½® APP å›¾æ ‡

ä¸ºäº†æ‰“åŒ…åè¿›è¡Œæµ‹è¯•çš„ APP ,ä¾¿äºå®šä½é—®é¢˜ï¼Œå¯ä»¥åœ¨ App Logo ä¸Šæ‰“ä¸Šæ°´å°ï¼ŒåŠ å…¥æ„å»ºä½¿ç”¨çš„Â `git åˆ†æ”¯å`ï¼Œ`jenkins æ„å»ºå·`ï¼Œ`app ç‰ˆæœ¬å·`Â ç­‰å…³é”®ä¿¡æ¯ã€‚

é…ç½®å›¾æ ‡æ°´å°çš„æµç¨‹ä¸º:

* åˆ¤æ–­æ­¤æ¬¡æ˜¯å¦ä¸º appstore åˆ†å‘å¹³å°ã€‚å¦‚æœæ˜¯ appstore çš„è¯ï¼Œå°†æ—§æœ‰çš„å›¾æ ‡ç›®å½•æ¸…ç†æ‰ï¼Œç„¶åå°†å›¾æ ‡å¤åˆ¶åˆ°ä½¿ç”¨çš„ç›®å½•ä¸­ã€‚
* å¦‚æœä¸æ˜¯ appstore ï¼Œåˆ™ä¸ºæµ‹è¯•å¹³å°åˆ†å‘ï¼Œè¿›è¡Œæ°´å°å¤„ç†ã€‚

#### 2.1 æ‰“åŒ…å‰æ›¿æ¢èµ„æº

> Note: åœ¨å¤„ç†å›¾æ ‡åšæ›¿æ¢æ—¶ï¼ŒåŸæ¥æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯åœ¨æ„å»ºå®Œæˆåï¼Œè¿›å…¥ app çš„èµ„æºä¸­è¿›è¡Œæ›¿æ¢ï¼ˆç°åœ¨è¡Œä¸é€šäº†ï¼‰ã€‚å¦ä¸€ç§æ˜¯ï¼Œç›´æ¥ä¿®æ”¹å·¥ç¨‹ä¸­çš„èµ„æºã€‚ ç›®å‰æ˜¯ç”¨çš„æ–¹æ³•ï¼Œå°±æ˜¯`ç›´æ¥ä¿®æ”¹å·¥ç¨‹ç›®å½•ä¸­çš„å›¾æ ‡æºæ–‡ä»¶`.æ‰€ä»¥è¦åœ¨æ„å»ºä¹‹å‰å®ŒæˆåŠ æ°´å°æ›¿æ¢ Logo.

å› ä¸ºè¦ä½¿ç”¨æ›¿æ¢èµ„æºçš„æ–¹å¼ï¼Œæ‰€ä»¥å‡†å¤‡ä¸¤ä¸ªç›®å½•ã€‚

ä¸€ä¸ªç›®å½•ä½œä¸ºÂ `æºç›®å½•`ï¼Œå­˜æ”¾æœªå¤„ç†çš„å›¾ç‰‡ã€‚ä¸€ä¸ªç›®å½•ä½œä¸º`ç›®æ ‡ç›®å½•`ï¼Œå­˜å‚¨ App Logo ä½¿ç”¨çš„å›¾ç‰‡ã€‚

ä¸ºä»€ä¹ˆä½¿ç”¨ä¸¤ä¸ªå›¾ç‰‡ç›®å½•å­˜å‚¨ï¼Ÿå‡è®¾åªç”¨ä¸€ä¸ªï¼ŒåŸå›¾ä¸ºAï¼Œå½“ç¬¬ä¸€æ¬¡å¤„ç†ï¼Œå›¾ç‰‡ä¸º A1æ°´å°å›¾ç‰‡ï¼Œå½“ç¬¬äºŒæ¬¡å†æ‹¿åˆ°çš„å›¾ç‰‡ï¼Œå·²ç»æ˜¯è¢«å¤„ç†è¿‡çš„ A1æ°´å°å›¾ç‰‡äº†ï¼Œè€Œä¸æ˜¯åŸå›¾A ã€‚

è¿™é‡Œæ³¨æ„Â `icons_path`Â ä¸ºå­˜æ”¾åŸå›¾çš„åœ°å€ï¼ŒÂ `icons_dest_path`Â ä¸ºè¦ä¿®æ”¹ä½¿ç”¨çš„ç›®æ ‡è·¯å¾„ã€‚ å‘½åä¸ºÂ `AppIcon-Internal`ã€‚

å¯ä»¥å‚è€ƒÂ [iOS APPå›¾æ ‡ç‰ˆæœ¬åŒ–](https://www.jianshu.com/p/a37e114b7e66)

å…³äº version çš„è·å–ï¼Œ å› ä¸ºç›®å‰ç‰ˆæœ¬æœ‰æ”¹åŠ¨ï¼Œä½¿ç”¨ ruby å»è·å–,è„šæœ¬ä¼šåœ¨åé¢æä¾›é“¾æ¥:

```bash  
version=$(ruby ./ToolChain/ruby/dy_build_version.rb ${Mode})
```

è¿˜æœ‰ä¸€ä¸ªä¸´æ—¶å­˜æ”¾è·¯å¾„ï¼Œè¦æå‰åˆ›å»ºå¥½è¿™ä¸ªæ–‡ä»¶å¤¹:

```bash  
tmp_path="/Users/${sys_username}/Desktop/iOS_IPA/IconVersioning
```

#### 2.2 ImageMagick

æ·»åŠ æ°´å°ä¸»è¦ä½¿ç”¨åˆ°äº†å‘½ä»¤è¡Œå·¥å…·Â `ImageMagick`Â ,æ‰€ä»¥è¦å…ˆå®‰è£…:

```bash  
brew install imagemagick
# å®‰è£…Ghostscriptï¼Œå®ƒæä¾›äº†æ”¯æŒImageMagickçš„å­—ä½“ã€‚
brew install ghostscript
```

#### 2.3 è„šæœ¬å†…å®¹

å…·ä½“çš„è„šæœ¬å¦‚ä¸‹:

```bash  
#!/bin/bash -l

echo "ğŸ› ------------- é…ç½® app å›¾æ ‡ --------------------"

#æœ¬æœº Mac çš„ç”¨æˆ·å 
sys_username="$USER" 
#Jenkins æ„å»ºçš„ä»»åŠ¡å
jenkinsName=${JOB_NAME}
# å·¥ç¨‹å
APP_NAME="your app name"
#é¡¹ç›® repo ç›®å½•
Workspace="${WORKSPACE}"

project_infoplist_path="./${APP_NAME}/Info.plist"
#ä¸´æ—¶å›¾ç‰‡å­˜æ”¾è·¯å¾„
tmp_path="/Users/${sys_username}/Desktop/iOS_IPA/IconVersioning"

# å¦‚æœå¹³å°ä¸º  appstore
if [ "$BetaPlatform" = "appstore" ];then
   echo "ğŸƒğŸƒğŸƒ  ä¸Šä¼ å¹³å° ä¸º appstore ğŸƒğŸƒğŸƒ"
   echo "icons_path: ${icons_path}"
   echo "icons_dest_path: ${icons_dest_path}"

#1.æ¸…é™¤åŸæ¥ png æ–‡ä»¶
find "${icons_dest_path}" -type f -name "*.png" -print0 |
while IFS= read -r -d '' file; do
echo "rm file $file"
rm -rf $file
done

#2\. icons_path å¤åˆ¶åˆ°icons_dest_path
find "${icons_path}" -type f -name "*.png" -print0 |
while IFS= read -r -d '' file; do
echo "file: ${file}"
image_name=$(basename $file)
echo "copy image: ${image_name}"
cp $file ${icons_dest_path}/${image_name}
done

else
# å¦‚æœå¹³å°ä¸ºå…¶å®ƒå†…æµ‹åˆ†å‘å¹³å°
   echo "ğŸƒğŸƒğŸƒ ä¸Šä¼ å¹³å° ä¸º pagyer/fir,åŠ æ°´å° ğŸƒğŸƒğŸƒ"

   convertPath=`which convert`
   echo ${convertPath}
   if [[ ! -f ${convertPath} || -z ${convertPath} ]]; then
      echo "warning: Skipping Icon versioning, you need to install ImageMagick and ghostscript (fonts) first, you can use brew to simplify process:
      brew install imagemagick
      brew install ghostscript"
      exit -1;
   fi

    # è¯´æ˜
    # version    app-ç‰ˆæœ¬å·
    # build_num  app-æ„å»ºç‰ˆæœ¬å·.
    version=$(ruby ./ToolChain/ruby/dy_build_version.rb ${Mode})
    build_num=${BUILD_NUMBER}

    # æ£€æŸ¥å½“å‰æ‰€å¤„Gitåˆ†æ”¯
    cut="$Branch"
     echo ${cut#*/}
    #shell æˆªå–å­—ç¬¦ä¸²
    branch=${cut#*/}

    shopt -s extglob
    build_num="${build_num##*( )}"
    shopt -u extglob

    #å›¾ç‰‡æ˜¾ç¤ºçš„æ–‡å­—å†…å®¹
    if [ "${isBeta}" = "YES" ];then
       echo " ğŸœğŸœğŸœ ä¸ºBeta ç‰ˆæœ¬"
       caption="${version}($build_num)\n${branch}(Beta)"
    else
      caption="${version}($build_num)\n${branch}"
    fi

    echo $caption

function abspath() { pushd . > /dev/null; if [ -d "$1" ]; then cd "$1"; dirs -l +0; else cd "`dirname \"$1\"`"; cur_dir=`dirs -l +0`; if [ "$cur_dir" == "/" ]; then echo "$cur_dir`basename \"$1\"`"; else echo "$cur_dir/`basename \"$1\"`"; fi; fi; popd > /dev/null; }

function processIcon() {
    base_file=$1
    temp_path=$2
    dest_path=$3

    if [[ ! -e $base_file ]]; then
    echo "error: file does not exist: ${base_file}"
    exit -1;
    fi

    if [[ -z $temp_path ]]; then
    echo "error: temp_path does not exist: ${temp_path}"
    exit -1;
    fi

    if [[ -z $dest_path ]]; then
    echo "error: dest_path does not exist: ${dest_path}"
    exit -1;
    fi

    file_name=$(basename "$base_file")
    final_file_path="${dest_path}/${file_name}"

    base_tmp_normalizedFileName="${file_name%.*}-normalized.${file_name##*.}"
    base_tmp_normalizedFilePath="${temp_path}/${base_tmp_normalizedFileName}"

# Normalize
    echo "Reverting optimized PNG to normal"
    echo "xcrun -sdk iphoneos pngcrush -revert-iphone-optimizations -q '${base_file}' '${base_tmp_normalizedFilePath}'"
    xcrun -sdk iphoneos pngcrush -revert-iphone-optimizations -q "${base_file}" "${base_tmp_normalizedFilePath}"

    width=`identify -format %w "${base_tmp_normalizedFilePath}"`
    height=`identify -format %h "${base_tmp_normalizedFilePath}"`

    band_height=$((($height * 50) / 100))
    band_position=$(($height - $band_height))
    text_position=$(($band_position - 8))
    point_size=$(((15 * $width) / 100))

    echo "Image dimensions ($width x $height) - band height $band_height @ $band_position - point size $point_size"

#
# blur band and text
#
    convert "${base_tmp_normalizedFilePath}" -blur 10x8 /tmp/blurred.png
    convert /tmp/blurred.png -gamma 0 -fill white -draw "rectangle 0,$band_position,$width,$height" /tmp/mask.png
    convert -size ${width}x${band_height} xc:none -fill 'rgba(0,0,0,0.2)' -draw "rectangle 0,0,$width,$band_height" /tmp/labels-base.png
    convert -background none -size ${width}x${band_height} -pointsize $point_size -fill white -gravity center -gravity South caption:"$caption" /tmp/labels.png

    convert "${base_tmp_normalizedFilePath}" /tmp/blurred.png /tmp/mask.png -composite /tmp/temp.png

    rm /tmp/blurred.png
    rm /tmp/mask.png

#
# compose final image
#
    filename=New"${base_file}"
    convert /tmp/temp.png /tmp/labels-base.png -geometry +0+$band_position -composite /tmp/labels.png -geometry +0+$text_position -geometry +${w}-${h} -composite -alpha remove "${final_file_path}"

# clean up
    rm /tmp/temp.png
    rm /tmp/labels-base.png
    rm /tmp/labels.png
    rm "${base_tmp_normalizedFilePath}"

    echo "Overlayed ${final_file_path}"
}

#æŠŠ appIcon çš„å›¾ç‰‡ï¼Œå¤åˆ¶åˆ° AppIcon-Internal
icons_path="${Workspace}/${APP_NAME}/Resources/Assets.xcassets/AppIcon.appiconset"
icons_dest_path="${Workspace}/${APP_NAME}/Resources/Assets.xcassets/AppIcon-Internal.appiconset"

icons_set=`basename "${icons_path}"`

echo "icons_path: ${icons_path}"
echo "icons_dest_path: ${icons_dest_path}"

    mkdir -p "${tmp_path}"

    if [[ $icons_dest_path == "\\" ]]; then
        echo "error: destination file path can't be the root directory"
        exit -1;
    fi

    rm -rf "${icons_dest_path}"
    cp -rf "${icons_path}" "${icons_dest_path}"

    # Reference: https://askubuntu.com/a/343753
    find "${icons_path}" -type f -name "*.png" -print0 |
    while IFS= read -r -d '' file; do
        echo "$file"
        processIcon "${file}" "${tmp_path}" "${icons_dest_path}"
    done

fi
```

### 3. Ruby ä¿®æ”¹å·¥ç¨‹å‚æ•°

è¿™é‡Œä½¿ç”¨ ruby å®ç°å‚æ•°ä¿®æ”¹(å½“ç„¶ä¹Ÿå¯ä½¿ç”¨ python ç­‰å„ç§è¯­è¨€ï¼Œè‡ªå·±æ–¹ä¾¿å°± OK )ã€‚

> æ ¹æ®è‡ªå·±çš„åœºæ™¯åšåŒºåˆ†ï¼Œæœ‰çš„å‚æ•°æ—¶ä¸è¦çš„å¯ä»¥ä¸åšã€‚è¿™é‡Œä¸»è¦è®°å½•ç¬”è€…è‡ªå·±ç”¨åˆ°çš„ï¼Œä¿®æ”¹å‚æ•°å’Œæ·»åŠ å‚æ•°æ ‡è®°çš„æ–¹æ³•

ç›®å‰åšçš„æ“ä½œï¼š

* åŒºåˆ†æ˜¯å¦ beta ç‰ˆæœ¬ -- ä¿®æ”¹å®šä¹‰Â `beta`Â å® çš„çœŸå‡å€¼
* ä¸åŒåˆ†å‘å¹³å°ï¼Œä½¿ç”¨ä¸åŒ bundleID -- å¯¹ bundleID è¿›è¡Œä¿®æ”¹

```bash  
#!/bin/bash -l

export LANG=en_US.UTF-8
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8

echo ${isBeta}
echo ${channel}

if [ "${isBeta}" = "YES" ];then
  echo " ğŸœğŸœğŸœ ä¸ºBeta ç‰ˆæœ¬"
  ruby ./ToolChain/ruby/dy_build_global.rb -isbeta-BETA -channel-${channel}
else
  echo " ğŸœğŸœğŸœ ä¸æ˜¯ Beta ç‰ˆæœ¬"
  ruby ./ToolChain/ruby/dy_build_global.rb -channel-${channel}
fi

if [ "$BetaPlatform" = "pgyer" ];then
  echo "pgyer ğŸŒ¹ ä¿®æ”¹bundleID  com.xx.yy.test , profile" 
  ruby ./ToolChain/ruby/dy_edit_profile.rb
fi

if [ "$BetaPlatform" = "appstore" ];then
  echo "appstore ğŸš€  ä¿æŒ bundleID,profile"
fi

if [ "$BetaPlatform" = "fir" ];then
   echo "fir ğŸš€  ä¿æŒ bundleID,profile"
fi
```

è„šæœ¬é‡Œä¾é  CocoaPods å¼€æºçš„Â [Xcodeproj](https://github.com/CocoaPods/Xcodeproj)Â ï¼Œå¯¹å·¥ç¨‹çš„ name.xcodeproj/project.pbxproj æ–‡ä»¶è¿›è¡Œé…ç½®ä¿®æ”¹ã€‚

python çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªé¡¹ç›®Â [mod-pbxproj](https://github.com/kronenthaler/mod-pbxproj)

### 4. Pod æ“ä½œ

å®‰è£…/æ›´æ–°ç¬¬ä¸‰æ–¹åº“ï¼Œè¿™é‡Œä½¿ç”¨åˆ°çš„æ˜¯ Cocoapods,å…¶å®ƒçš„åŒ…ç®¡ç†å™¨å¯ä½¿ç”¨å…¶å®ƒæ–¹å¼ã€‚

```bash  
echo "ğŸŒ² ------------- Pod æ“ä½œ --------------------"
pod update --verbose --no-repo-update
echo "ğŸŒ² ------------- Pod å®Œæˆ --------------------"
```

## æ‰§è¡Œæ„å»º

### 1. å‡†å¤‡å·¥ä½œ

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¦åšäº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚è®¾ç½®è¦ä½¿ç”¨çš„å˜é‡ï¼Œå¸¸é‡ã€‚

éœ€è¦æå‰å†™å¥½ï¼Œå°½é‡é¿å…æ•£è½ã€‚

```bash  
echo "ğŸŒ° ------------- è·å–ææ–™ --------------"

#æœ¬æœº Mac çš„ç”¨æˆ·å
sys_username="$USER"
#Jenkins æ„å»ºçš„ä»»åŠ¡å
jenkinsName=${JOB_NAME}
# å·¥ç¨‹å
APP_NAME=""
#schemeå
SCHEME_NAME=""

#å·¥ç¨‹ç»å¯¹è·¯å¾„
project_path="${WORKSPACE}"
#æ—¶é—´
DATE="$(date +%Y-%m-%d-%H-%M-)"
#info.plistè·¯å¾„
project_infoplist_path="./${APP_NAME}/Info.plist"

#buglys å‘½ä»¤è¡Œå·¥å…·è·¯å¾„
buglyPath=/Users/${sys_username}/Desktop/buglySymboliOS

```

#### 1.1 Build å·ç›¸å…³

æ—§æœ‰çš„æ–¹å¼ï¼Œæ˜¯ç›´æ¥é€šè¿‡ info.plist å–:

```bash  
#version
bundleVersion=$(/usr/libexec/PlistBuddy -c "print CFBundleShortVersionString" "${project_infoplist_path}")

#bundleID
BundleID=$(/usr/libexec/PlistBuddy -c "print CFBundleIdentifier" "${project_infoplist_path}")
```

ç„¶è€Œåœ¨æ–°çš„ Xcode å–Â `ç‰ˆæœ¬å·`Â å’Œ bundleID çš„æ–¹å¼å‘ç”Ÿå˜åŒ–ï¼Œ ç°åœ¨Â `info.plist`Â é‡Œçš„å€¼æ˜¯å˜é‡å,å–ç‰ˆæœ¬å·ä¸ºÂ `$(MARKETING_VERSION)`, bundleID ä¸ºÂ `$(PRODUCT_BUNDLE_IDENTIFIER)`.

ç»“å±€æ€è·¯æ˜¯é€šè¿‡è„šæœ¬åˆ°å·¥ç¨‹é…ç½®é‡Œå»è·å–ï¼Œä¸‹é¢ä½¿ç”¨ ruby å®ç°äº†è¿™ä¸¤ä¸ªç›®çš„ã€‚

æˆ‘ä»¬å°† App ä¸ Jenkins çš„ build number è®¾ç½®ä¸ºåŒä¸€ä¸ªï¼Œæ–¹ä¾¿éœ€è¦æ—¶ï¼ŒæŸ¥çœ‹æ„å»ºçš„å‚æ•°ä»¥åŠç¬¦å·è¡¨ç­‰:

```bash  
#é€šè¿‡è„šæœ¬å–å¾—å–ç‰ˆæœ¬å· x.x.x 
bundleShortVersion=$(ruby ./ToolChain/ruby/dy_build_version.rb "${Mode}")

#é€šè¿‡è„šæœ¬å–å¾— bundleID
BundleID=$(ruby ./ToolChain/ruby/dy_build_bundIeID.rb "${Mode}")

#ä¿®æ”¹ ipa çš„ build å·ï¼Œå’Œ jenkins æ„å»ºå·ç›¸åŒ
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "${project_infoplist_path}"

#å–buildå€¼
bundleVersion=$(/usr/libexec/PlistBuddy -c "print CFBundleVersion" "${project_infoplist_path}")

#  bundleVersion æ­£å¸¸æƒ…å†µè¦ä¸ BUILD_NUMBER ä¸€æ ·
echo "BundleID:${BundleID} Verision:${bundleVersion} Jenkins Build: $BUILD_NUMBER "
```

### 2. ä½¿ç”¨Â `security`Â è§£é”é’¥åŒ™ä¸².

åŠ å…¥Â `security`Â è§£é”æ“ä½œçš„åŸå› ,æ˜¯åœ¨å­èŠ‚ç‚¹â€‰sshâ€‰ç™»å½•ä¸Šå»ä¹‹åï¼Œkeychainâ€‰æ²¡æœ‰è¢«è§£é”.å¯¼è‡´æ‰“åŒ…å¤±è´¥.

è§£å†³æ–¹æ¡ˆæ˜¯ç”¨â€‰security unlock-keychainâ€‰å‘½ä»¤å°†è¯ä¹¦è§£é”ã€‚

```bash  
# è¿™é‡Œé»˜è®¤æ˜¯â€‰login keychainï¼Œlogin keychainâ€‰çš„å¯†ç é»˜è®¤æ˜¯ç”¨æˆ·çš„ç™»å½•å¯†ç 
security -v unlock-keychain -p "password"
```

å¦å¤–å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹æè¿°æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ åŒ…æ‹¬UUIDç­‰ä¿¡æ¯

```bash  
/usr/bin/security cms -D -i æ–‡ä»¶è·¯å¾„
```

### 3. Xcodebuild

å¯¹å·¥ç¨‹è¿›è¡Œæ„å»ºæ‰“åŒ…ï¼Œä¸»è¦åœ¨äºä½¿ç”¨ Xcodebuild .

åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

* Clean
* Archive
* Export

å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åˆä¸å–œæ¬¢æ—¥å¿—è¾“å‡ºçš„ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œæœ€ååŠ ä¸Š

```bash  
-quiet    #åªæœ‰ warn å’Œ error æ‰ä¼šè¾“å‡º
```

### 4. æ¸…ç†å·¥ç¨‹

æ¯æ¬¡æ„å»ºæ—¶ï¼Œå¯¹å·¥ç¨‹è¿›è¡Œ clean ,ä¿è¯æ²¡æœ‰å…¶å®ƒå½±å“çš„å› ç´ ã€‚

ä½¿ç”¨`xcodebuild clean [-optionName]...`æ¸…é™¤ç¼–è¯‘è¿‡ç¨‹ç”Ÿæˆæ–‡ä»¶,ä½¿ç”¨å¦‚ä¸‹ï¼š

```bash  
#//ä¸‹é¢æ˜¯é›†æˆæœ‰Cocopodsçš„ç”¨æ³•
echo "ğŸï¸ğŸï¸ =================clean=================  ğŸï¸ğŸï¸ "

xcodebuild clean -workspace "${APP_NAME}.xcworkspace" -scheme "${APP_NAME}"  -configuration ${development_mode} -UseModernBuildSystem=YES

```

é cocoapods çš„å·¥ç¨‹ï¼Œå°†Â `-workspace "${APP_NAME}.xcworkspace"`Â æ¢æˆÂ `-project ${APP_NAME}.xcodeproj`Â å³å¯ã€‚

æ–°ç‰ˆæœ¬çš„ Xcode æœ‰äº†æ–°çš„æ„å»ºç³»ç»Ÿï¼Œä½¿ç”¨Â `-UseModernBuildSystem=<value>`Â æ¥åšæ–°æ—§åŒºåˆ†ã€‚

| å‘½ä»¤ | è¯´æ˜ |
| :-- | :-- |
| -workspace NAME | æŒ‡å®šå·¥ä½œç©ºé—´æ–‡ä»¶XXX.xcworkspace |
| -scheme NAME | æŒ‡å®šæ„å»ºå·¥ç¨‹åç§° |
| -configuration [Debug/Release] | é€‰æ‹©Debugæˆ–è€…Releaseæ„å»º |
| -sdk NAME | æŒ‡å®šç¼–è¯‘æ—¶ä½¿ç”¨çš„SDK |

### 5. æ„å»º archive åŒ…

Xcodebuild archive

```bash  
echo "ğŸš—ğŸš—ğŸš— *** æ­£åœ¨ ç¼–è¯‘å·¥ç¨‹ For ${development_mode} ğŸš—ğŸš—ğŸš—"

xcworkspace=${project_path}/${APP_NAME}.xcworkspace
echo "acrhivie xcworkspace : ${xcworkspace}"

xcodebuild \
archive -workspace  ${xcworkspace} \
-scheme ${SCHEME_NAME} \
-configuration ${development_mode} \
-archivePath ${build_path}/${APP_NAME}.xcarchive \
-quiet 

echo 'âœ… *** ç¼–è¯‘å®Œæˆ ***'
```

### 6. å¯¼å‡º IPA åŒ…

```bash  
security -v unlock-keychain -p "yourpassword"

echo 'ğŸš„ ***************** æ­£åœ¨ æ‰“åŒ…  ***************** ğŸš„ '

xcodebuild -exportArchive -archivePath ${build_path}/${APP_NAME}.xcarchive \
-exportPath ${exportFilePath} \
-exportOptionsPlist ${exportOptionsPlist_path} \
-allowProvisioningUpdates \
-quiet
```

æ›´æ–°åˆ°Xcode9.0åï¼Œä¹‹å‰å†™çš„è‡ªåŠ¨æ‰“åŒ…è„šæœ¬ä¸å¯ç”¨äº†ã€‚

éœ€è¦æ·»åŠ Â `-allowProvisioningUpdates`ï¼Œè·å–è®¿é—®é’¥åŒ™ä¸²æƒé™çš„å…³é”®æ‰€åœ¨ï¼Œè®¾ç½®äº†è¿™ä¸ªå­—æ®µå°±ä¼šåœ¨æ‰“åŒ…è¿‡ç¨‹å¼¹æ¡†è¯·æ±‚è·å–é’¥åŒ™ä¸²å†…å®¹æƒé™ã€‚

#### 6.1 exportOptionsPlist è®¾ç½®

ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼ŒexportOptionsPlist ä¸€å®šè¦æ£€æŸ¥,ä¸åŒçš„ç¯å¢ƒå’Œåˆ†å‘å¹³å°è¦é€‰æ‹©å¯¹ã€‚

æœ€ç®€å•æ–¹å¼ï¼Œå°±æ˜¯è°ƒå¥½éœ€è¦çš„ç¯å¢ƒåï¼Œç›´æ¥æ‰‹åŠ¨ archive ,export å‡ºæ¥ï¼Œä½¿ç”¨äº§ç‰©é‡Œçš„ exportOptionsPlist æ–‡ä»¶ã€‚

![exoprotOptionsPlist](/assets/postAssets/2019/20200813081412.png)





#### 6.2 æ£€æŸ¥ ipa

æ£€æŸ¥å¯¹åº”è·¯å¾„æ˜¯å¦æœ‰ **.ipa æ–‡ä»¶:

```bash  
if [ -e ${exportFilePath}/${APP_NAME}.ipa ]; then
echo "âœ… *** .ipaæ–‡ä»¶å·²å¯¼å‡º ***"
echo $exportFilePath

else
echo "âŒ *** åˆ›å»º.ipaæ–‡ä»¶å¤±è´¥ ***"
exit 1
fi

echo 'ğŸ“¦  *** æ‰“åŒ…å®Œæˆ ***'
```

## æ„å»ºå®Œæˆ

### 1. ä¸Šä¼ åˆ†å‘å¹³å°

è¿™é‡Œåˆ†ä¸º è’²å…¬è‹±,fir,appstore ä¸‰ä¸ªå¹³å°ï¼Œä¸Šä¼  IPA.

> å¦‚æœä¸º appstore, åˆ™å¤šå‡ºä¸€ä¸ª git tag çš„ç›¸å…³æ“ä½œï¼Œæ ‡è®°ä¸Šå½“å‰ç‰ˆæœ¬çš„æäº¤ï¼Œæ–¹ä¾¿éœ€è¦æ—¶ç›´æ¥å›é€€ä»£ç è¿›è¡ŒæŸ¥çœ‹ã€‚

ä¸‹é¢ä½¿ç”¨çš„ä¸‰ä¸ªä¸Šä¼ å‘½ä»¤ï¼Œæœ€å¥½å…ˆæå‰åœ¨æœºå™¨ä¸Šå®éªŒå¯ä»¥æ­£å¸¸ç”¨å†æ„å»ºã€‚

```bash  
if [ "$BetaPlatform" = "pgyer" ];then

      echo "ğŸš€ ä¸Šä¼ è’²å…¬è‹± ++++++++++++++upload+++++++++++++"
      #User Key
      uKey="User Key"
      #API Key
      apiKey="API Key"
      #æ‰§è¡Œä¸Šä¼ è‡³è’²å…¬è‹±çš„å‘½ä»¤
      curl -F "file=@${IPA_PATH}" -F "uKey=${uKey}" -F "_api_key=${apiKey}" -F "buildPassword=yourpassword" -F "buildInstallType=2" http://www.pgyer.com/apiv2/app/upload
      echo "âœ… Finsh - è’²å…¬è‹±ä¸Šä¼ å®Œæ¯•"
fi

if [ "$BetaPlatform" = "fir" ];then
      echo "ğŸš€ ä¸Šä¼ Fir ++++++++++++++upload+++++++++++++"

      fir p ${IPA_PATH} -T your_token

      echo "âœ… Finsh - Fir ä¸Šä¼ å®Œæ¯•"
fi

if [ "$BetaPlatform" = "appstore" ];then

   echo "ğŸ  ------------appstore xcrun ä¸Šä¼ åˆ° appstore  ----------"

   xcrun altool --upload-app -f ${IPA_PATH} -u your_account -p your_app_password  --verbose

   echo "ğŸ“ ------------appstore å¢åŠ  Git Tag ----------"

    echo "--------- å½“å‰ Tag -----------"
    git tag

    echo "--------- æ‰“ Tag ------------"
    GitTag=V${bundleShortVersion}_${bundleVersion}

    git tag -a ${GitTag} -m "Tag:${GitTag} "
    echo "Tag ${GitTag}"

   #æ¨é€æ ‡ç­¾
    git push origin ${GitTag}

    echo "âœ… ----------- Git Tag æ¨é€å®Œæ¯• ----------"
fi
```

### 2. ç¬¦å·è¡¨å¤„ç†

ä¸Šä¼  bugly

```bash  
echo " ğŸ“¦ ------ å¼€å§‹ç¬¦å·è¡¨ ç›¸å…³å·¥ä½œ ------"

echo " Â©ï¸ ----- ä¸Šä¼ ç¬¦å·è¡¨ ------- Â©ï¸"

if [ "$BetaPlatform" = "appstore" ];then
   echo "ğŸš€  Bugly  æ­£å¼ç‰ˆæœ¬ç¬¦å·è¡¨"
   buglyID= your_product_buglyID
   buglyKey= your_product_buglyKey

else
   echo "ğŸš€  Bugly  æµ‹è¯•ç‰ˆæœ¬ç¬¦å·è¡¨"
   buglyID= your_dev_buglyID
   buglyKey=your_dev_buglyKey
fi

dSYMPath=$exportFilePath/${APP_NAME}.xcarchive/dSYMs/
cd $buglyPath 

echo "----- å¼€å§‹ä¸Šä¼ ç¬¦å·è¡¨ ---------- "
java -jar buglySymboliOS.jar \
-i ${dSYMPath}/${APP_NAME}.app.dSYM \
-u -id ${buglyID} \
-key  ${buglyKey} \
-package ${BundleID} \
-version ${bundleShortVersion}

echo "âœ… ---------- ä¸Šä¼ ç¬¦å·è¡¨å®Œæ¯• ------ âœ… "
```

### 3. å½’æ¡£äº§ç‰©

è¿›è¡Œå®Œæ‰€æœ‰æ“ä½œåï¼Œå¯¹äºäº§ç‰©åšä¸€æ¬¡ä¿å­˜ï¼Œéœ€è¦æ—¶å¯ä»¥ç”¨ä¸Šã€‚

#### 3.1 å‹ç¼©

é¦–å…ˆå°†æ–‡ä»¶å‹ç¼©

```bash  
echo "ğŸ“¦ ---------- å‹ç¼©æ–‡ä»¶ ------ ğŸ“¦ "

#æ‰“å¼€ç›®å½•
cd $exportFilePath
zip -r ./${JOB_NAME}_${BUILD_NUMBER}.zip ./* 

#æ¸…ç†æ–‡ä»¶ **.xcarchive
rm -rf ${APP_NAME}.xcarchive
```

#### 3.2 ä¸Šä¼  FTP æœåŠ¡å™¨

é€šè¿‡ FTP æ’ä»¶ï¼ŒæŠŠ zip æ–‡ä»¶ä¸Šä¼ åˆ°å½’æ¡£çš„è·¯å¾„ä¸‹

![uploadFTP](/assets/postAssets/2019/20200813074301.png)


#### 3.3 äº§ç‰©æ¸…ç†

åˆ é™¤ IPA ç­‰æ–‡ä»¶ï¼Œæ³¨æ„çš„æ˜¯ï¼Œå½“çŠ¶æ€ä¸ºÂ `success`Â æ‰æ¸…ç†ï¼Œé¿å…æœ‰æ—¶ä¸Šä¼ å‡ºé—®é¢˜ï¼Œå¯ä»¥è¿›è¡Œæ‰‹åŠ¨ä¸Šä¼ ã€‚

![deleteIPA](/assets/postAssets/2019/20200813074757.png)


#### 3.4 æ„å»ºæè¿°

è®¾ç½®æ„å»ºæè¿°

![build description](/assets/postAssets/2019/20200813074616.png)

### 4. è¿›è¡Œé€šçŸ¥

å®Œæˆåï¼Œä¼ä¸šå¾®ä¿¡ webhook æœºå™¨äººæ¨é€ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

![caijibuild_notify](/assets/postAssets/2019/caijibuild_notify.png)

è¿™é‡Œè®¾ç½®æˆå¯é€‰é¡¹ï¼Œé¿å…é¢‘ç¹æ‰“æ‰°å…¶å®ƒåŒäº‹ã€‚è„šæœ¬å¦‚ä¸‹:

```bash  
if [ "${BotPush}" = "YES" ];then

version=$(ruby ./ToolChain/ruby/dy_build_version.rb ${Mode})
downUrl="pgyer url"

if [ "$BetaPlatform" = "fir" ];then
  downUrl="fir url"
fi

#ç¾¤é‡Œæœºå™¨äººåœ°å€
ROBOT=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=yourkey

curl ''${ROBOT}'' \
   -H 'Content-Type: application/json' \
   -d '
   {
   "msgtype": "markdown",
   "markdown": {
               "content":  "### iOS æ„å»º \nç‰ˆæœ¬ <font color=\"warning\">'${version}'</font> <font color=\"info\">#'${BUILD_NUMBER}'</font>\nç¯å¢ƒ <font color=\"comment\">'${Mode}'</font>\nå¹³å° <font color=\"warning\">'${BetaPlatform}'</font>\n>[ä¸‹è½½åœ°å€ ]('${downUrl}')"
              }
   }'

fi
```

## å‚è€ƒæ–‡ç« 

* [Xcode10 æ–°ç‰¹æ€§](https://juejin.im/post/6844903843994533896)
* [Xcodebuildå‘½ä»¤ä½¿ç”¨](https://www.cnblogs.com/zhou--fei/p/11371019.html)
* [Xcodebuildå‘½ä»¤å®˜æ–¹è¯´æ˜](https://www.jianshu.com/p/4f4d16326152)
* [ä½¿ç”¨ Xcodebuild å‘½ä»¤è¿›è¡Œè‡ªåŠ¨åŒ–æ‰“åŒ…](https://www.jianshu.com/p/f50053d50436)
* [Xcodeè‡ªåŠ¨æ‰“åŒ…é‚£äº›äº‹](https://dengweijun.com/2018/12/26/Xcode%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85%E9%82%A3%E4%BA%9B%E4%BA%8B/)
